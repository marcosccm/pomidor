#!/usr/bin/env ruby
require "redis"
require "main"
require_relative "./../lib/pomidor"

Main do
  fattr(:redis) { Redis.new } 
  fattr(:tracker) { Pomidor::PomodoroTracker.new } 

  def run
    help!
  end

  mode("project") do
    mode("create") do
      description("create a new project")
      argument("name") do
        description("the name of the new project")
      end
      def run 
        id = redis.llen("pomidor:projects") + 1
        last_id = redis.set("pomidor:current_project", id)
        redis.lpush("pomidor:projects", id)
        redis.hset("pomidor:projects:#{id}", "name", params["name"].value)
      end
    end

    mode("list") do
      def run
        puts *tracker.project_names
      end
    end

    mode("current") do
      description("gets the current project, or get it, if an id is passed")
      argument("id") do
        description("the id to set the current project")
        required false
      end

      def run
        if params["id"].given?
          redis.set("pomidor:current_project", params["id"].value)
        end

        last_id = redis.get("pomidor:current_project")
        name = redis.hget("pomidor:projects:#{last_id}", "name")
        puts name
      end
    end
  end
end
